"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _moment = _interopRequireDefault(require("moment"));
var _constants = require("../constants");
var _debug = require("../helpers/debug");
var _elementsInteractions = require("../helpers/elements-interactions");
var _transactions = require("../helpers/transactions");
var _transactions2 = require("../transactions");
var _baseScraperWithBrowser = require("./base-scraper-with-browser");
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const debug = (0, _debug.getDebug)('beyahadBishvilha');
const DATE_FORMAT = 'DD/MM/YY';
const LOGIN_URL = 'https://www.hist.org.il/login';
const SUCCESS_URL = 'https://www.hist.org.il/';
const CARD_URL = 'https://www.hist.org.il/card/balanceAndUses';
function getAmountData(amountStr) {
  const amountStrCln = amountStr.replace(',', '');
  let currency = null;
  let amount = null;
  if (amountStrCln.includes(_constants.SHEKEL_CURRENCY_SYMBOL)) {
    amount = parseFloat(amountStrCln.replace(_constants.SHEKEL_CURRENCY_SYMBOL, ''));
    currency = _constants.SHEKEL_CURRENCY;
  } else if (amountStrCln.includes(_constants.DOLLAR_CURRENCY_SYMBOL)) {
    amount = parseFloat(amountStrCln.replace(_constants.DOLLAR_CURRENCY_SYMBOL, ''));
    currency = _constants.DOLLAR_CURRENCY;
  } else if (amountStrCln.includes(_constants.EURO_CURRENCY_SYMBOL)) {
    amount = parseFloat(amountStrCln.replace(_constants.EURO_CURRENCY_SYMBOL, ''));
    currency = _constants.EURO_CURRENCY;
  } else {
    const parts = amountStrCln.split(' ');
    [currency] = parts;
    amount = parseFloat(parts[1]);
  }
  return {
    amount,
    currency
  };
}
function convertTransactions(txns) {
  debug(`convert ${txns.length} raw transactions to official Transaction structure`);
  return txns.map(txn => {
    const chargedAmountTuple = getAmountData(txn.chargedAmount || '');
    const txnProcessedDate = (0, _moment.default)(txn.date, DATE_FORMAT);
    const result = {
      type: _transactions2.TransactionTypes.Normal,
      status: _transactions2.TransactionStatuses.Completed,
      date: txnProcessedDate.toISOString(),
      processedDate: txnProcessedDate.toISOString(),
      originalAmount: chargedAmountTuple.amount,
      originalCurrency: chargedAmountTuple.currency,
      chargedAmount: chargedAmountTuple.amount,
      chargedCurrency: chargedAmountTuple.currency,
      description: txn.description || '',
      memo: '',
      identifier: txn.identifier
    };
    return result;
  });
}
async function fetchTransactions(page, options) {
  await page.goto(CARD_URL);
  await (0, _elementsInteractions.waitUntilElementFound)(page, '.react-loading.hide', false);
  const defaultStartMoment = (0, _moment.default)().subtract(1, 'years');
  const startDate = options.startDate || defaultStartMoment.toDate();
  const startMoment = _moment.default.max(defaultStartMoment, (0, _moment.default)(startDate));
  const accountNumber = await (0, _elementsInteractions.pageEval)(page, '.wallet-details div:nth-of-type(2)', null, element => {
    return element.innerText.replace('מספר כרטיס ', '');
  });
  const balance = await (0, _elementsInteractions.pageEval)(page, '.wallet-details div:nth-of-type(4) > span:nth-of-type(2)', null, element => {
    return element.innerText;
  });
  debug('fetch raw transactions from page');
  const rawTransactions = await (0, _elementsInteractions.pageEvalAll)(page, '.transaction-container, .transaction-component-container', [], items => {
    return items.map(el => {
      const columns = el.querySelectorAll('.transaction-item > span');
      if (columns.length === 7) {
        return {
          date: columns[0].innerText,
          identifier: columns[1].innerText,
          description: columns[3].innerText,
          type: columns[5].innerText,
          chargedAmount: columns[6].innerText
        };
      }
      return null;
    });
  });
  debug(`fetched ${rawTransactions.length} raw transactions from page`);
  const accountTransactions = convertTransactions(rawTransactions.filter(item => !!item));
  debug('filer out old transactions');
  const txns = options.outputData?.enableTransactionsFilterByDate ?? true ? (0, _transactions.filterOldTransactions)(accountTransactions, startMoment, false) : accountTransactions;
  debug(`found ${txns.length} valid transactions out of ${accountTransactions.length} transactions for account ending with ${accountNumber.substring(accountNumber.length - 2)}`);
  return {
    accountNumber,
    balance: getAmountData(balance).amount,
    txns
  };
}
function getPossibleLoginResults() {
  const urls = {};
  urls[_baseScraperWithBrowser.LoginResults.Success] = [SUCCESS_URL];
  urls[_baseScraperWithBrowser.LoginResults.ChangePassword] = []; // TODO
  urls[_baseScraperWithBrowser.LoginResults.InvalidPassword] = []; // TODO
  urls[_baseScraperWithBrowser.LoginResults.UnknownError] = []; // TODO
  return urls;
}
function createLoginFields(credentials) {
  return [{
    selector: '#loginId',
    value: credentials.id
  }, {
    selector: '#loginPassword',
    value: credentials.password
  }];
}
class BeyahadBishvilhaScraper extends _baseScraperWithBrowser.BaseScraperWithBrowser {
  getViewPort() {
    return {
      width: 1500,
      height: 800
    };
  }
  getLoginOptions(credentials) {
    return {
      loginUrl: LOGIN_URL,
      fields: createLoginFields(credentials),
      submitButtonSelector: async () => {
        const button = await this.page.$('xpath//button[contains(., "התחבר")]');
        if (button) {
          await button.click();
        }
      },
      possibleResults: getPossibleLoginResults()
    };
  }
  async fetchData() {
    const account = await fetchTransactions(this.page, this.options);
    return {
      success: true,
      accounts: [account]
    };
  }
}
var _default = exports.default = BeyahadBishvilhaScraper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbW9tZW50IiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfY29uc3RhbnRzIiwiX2RlYnVnIiwiX2VsZW1lbnRzSW50ZXJhY3Rpb25zIiwiX3RyYW5zYWN0aW9ucyIsIl90cmFuc2FjdGlvbnMyIiwiX2Jhc2VTY3JhcGVyV2l0aEJyb3dzZXIiLCJlIiwiX19lc01vZHVsZSIsImRlZmF1bHQiLCJkZWJ1ZyIsImdldERlYnVnIiwiREFURV9GT1JNQVQiLCJMT0dJTl9VUkwiLCJTVUNDRVNTX1VSTCIsIkNBUkRfVVJMIiwiZ2V0QW1vdW50RGF0YSIsImFtb3VudFN0ciIsImFtb3VudFN0ckNsbiIsInJlcGxhY2UiLCJjdXJyZW5jeSIsImFtb3VudCIsImluY2x1ZGVzIiwiU0hFS0VMX0NVUlJFTkNZX1NZTUJPTCIsInBhcnNlRmxvYXQiLCJTSEVLRUxfQ1VSUkVOQ1kiLCJET0xMQVJfQ1VSUkVOQ1lfU1lNQk9MIiwiRE9MTEFSX0NVUlJFTkNZIiwiRVVST19DVVJSRU5DWV9TWU1CT0wiLCJFVVJPX0NVUlJFTkNZIiwicGFydHMiLCJzcGxpdCIsImNvbnZlcnRUcmFuc2FjdGlvbnMiLCJ0eG5zIiwibGVuZ3RoIiwibWFwIiwidHhuIiwiY2hhcmdlZEFtb3VudFR1cGxlIiwiY2hhcmdlZEFtb3VudCIsInR4blByb2Nlc3NlZERhdGUiLCJtb21lbnQiLCJkYXRlIiwicmVzdWx0IiwidHlwZSIsIlRyYW5zYWN0aW9uVHlwZXMiLCJOb3JtYWwiLCJzdGF0dXMiLCJUcmFuc2FjdGlvblN0YXR1c2VzIiwiQ29tcGxldGVkIiwidG9JU09TdHJpbmciLCJwcm9jZXNzZWREYXRlIiwib3JpZ2luYWxBbW91bnQiLCJvcmlnaW5hbEN1cnJlbmN5IiwiY2hhcmdlZEN1cnJlbmN5IiwiZGVzY3JpcHRpb24iLCJtZW1vIiwiaWRlbnRpZmllciIsImZldGNoVHJhbnNhY3Rpb25zIiwicGFnZSIsIm9wdGlvbnMiLCJnb3RvIiwid2FpdFVudGlsRWxlbWVudEZvdW5kIiwiZGVmYXVsdFN0YXJ0TW9tZW50Iiwic3VidHJhY3QiLCJzdGFydERhdGUiLCJ0b0RhdGUiLCJzdGFydE1vbWVudCIsIm1heCIsImFjY291bnROdW1iZXIiLCJwYWdlRXZhbCIsImVsZW1lbnQiLCJpbm5lclRleHQiLCJiYWxhbmNlIiwicmF3VHJhbnNhY3Rpb25zIiwicGFnZUV2YWxBbGwiLCJpdGVtcyIsImVsIiwiY29sdW1ucyIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJhY2NvdW50VHJhbnNhY3Rpb25zIiwiZmlsdGVyIiwiaXRlbSIsIm91dHB1dERhdGEiLCJlbmFibGVUcmFuc2FjdGlvbnNGaWx0ZXJCeURhdGUiLCJmaWx0ZXJPbGRUcmFuc2FjdGlvbnMiLCJzdWJzdHJpbmciLCJnZXRQb3NzaWJsZUxvZ2luUmVzdWx0cyIsInVybHMiLCJMb2dpblJlc3VsdHMiLCJTdWNjZXNzIiwiQ2hhbmdlUGFzc3dvcmQiLCJJbnZhbGlkUGFzc3dvcmQiLCJVbmtub3duRXJyb3IiLCJjcmVhdGVMb2dpbkZpZWxkcyIsImNyZWRlbnRpYWxzIiwic2VsZWN0b3IiLCJ2YWx1ZSIsImlkIiwicGFzc3dvcmQiLCJCZXlhaGFkQmlzaHZpbGhhU2NyYXBlciIsIkJhc2VTY3JhcGVyV2l0aEJyb3dzZXIiLCJnZXRWaWV3UG9ydCIsIndpZHRoIiwiaGVpZ2h0IiwiZ2V0TG9naW5PcHRpb25zIiwibG9naW5VcmwiLCJmaWVsZHMiLCJzdWJtaXRCdXR0b25TZWxlY3RvciIsImJ1dHRvbiIsIiQiLCJjbGljayIsInBvc3NpYmxlUmVzdWx0cyIsImZldGNoRGF0YSIsImFjY291bnQiLCJzdWNjZXNzIiwiYWNjb3VudHMiLCJfZGVmYXVsdCIsImV4cG9ydHMiXSwic291cmNlcyI6WyIuLi8uLi9zcmMvc2NyYXBlcnMvYmV5YWhhZC1iaXNodmlsaGEudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnO1xyXG5pbXBvcnQgeyB0eXBlIFBhZ2UgfSBmcm9tICdwdXBwZXRlZXInO1xyXG5pbXBvcnQge1xyXG4gIERPTExBUl9DVVJSRU5DWSxcclxuICBET0xMQVJfQ1VSUkVOQ1lfU1lNQk9MLFxyXG4gIEVVUk9fQ1VSUkVOQ1ksXHJcbiAgRVVST19DVVJSRU5DWV9TWU1CT0wsXHJcbiAgU0hFS0VMX0NVUlJFTkNZLFxyXG4gIFNIRUtFTF9DVVJSRU5DWV9TWU1CT0wsXHJcbn0gZnJvbSAnLi4vY29uc3RhbnRzJztcclxuaW1wb3J0IHsgZ2V0RGVidWcgfSBmcm9tICcuLi9oZWxwZXJzL2RlYnVnJztcclxuaW1wb3J0IHsgcGFnZUV2YWwsIHBhZ2VFdmFsQWxsLCB3YWl0VW50aWxFbGVtZW50Rm91bmQgfSBmcm9tICcuLi9oZWxwZXJzL2VsZW1lbnRzLWludGVyYWN0aW9ucyc7XHJcbmltcG9ydCB7IGZpbHRlck9sZFRyYW5zYWN0aW9ucyB9IGZyb20gJy4uL2hlbHBlcnMvdHJhbnNhY3Rpb25zJztcclxuaW1wb3J0IHsgVHJhbnNhY3Rpb25TdGF0dXNlcywgVHJhbnNhY3Rpb25UeXBlcywgdHlwZSBUcmFuc2FjdGlvbiB9IGZyb20gJy4uL3RyYW5zYWN0aW9ucyc7XHJcbmltcG9ydCB7IEJhc2VTY3JhcGVyV2l0aEJyb3dzZXIsIExvZ2luUmVzdWx0cywgdHlwZSBQb3NzaWJsZUxvZ2luUmVzdWx0cyB9IGZyb20gJy4vYmFzZS1zY3JhcGVyLXdpdGgtYnJvd3Nlcic7XHJcbmltcG9ydCB7IHR5cGUgU2NyYXBlck9wdGlvbnMgfSBmcm9tICcuL2ludGVyZmFjZSc7XHJcblxyXG5jb25zdCBkZWJ1ZyA9IGdldERlYnVnKCdiZXlhaGFkQmlzaHZpbGhhJyk7XHJcblxyXG5jb25zdCBEQVRFX0ZPUk1BVCA9ICdERC9NTS9ZWSc7XHJcbmNvbnN0IExPR0lOX1VSTCA9ICdodHRwczovL3d3dy5oaXN0Lm9yZy5pbC9sb2dpbic7XHJcbmNvbnN0IFNVQ0NFU1NfVVJMID0gJ2h0dHBzOi8vd3d3Lmhpc3Qub3JnLmlsLyc7XHJcbmNvbnN0IENBUkRfVVJMID0gJ2h0dHBzOi8vd3d3Lmhpc3Qub3JnLmlsL2NhcmQvYmFsYW5jZUFuZFVzZXMnO1xyXG5cclxuaW50ZXJmYWNlIFNjcmFwZWRUcmFuc2FjdGlvbiB7XHJcbiAgZGF0ZTogc3RyaW5nO1xyXG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XHJcbiAgdHlwZTogc3RyaW5nO1xyXG4gIGNoYXJnZWRBbW91bnQ6IHN0cmluZztcclxuICBpZGVudGlmaWVyOiBzdHJpbmc7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEFtb3VudERhdGEoYW1vdW50U3RyOiBzdHJpbmcpIHtcclxuICBjb25zdCBhbW91bnRTdHJDbG4gPSBhbW91bnRTdHIucmVwbGFjZSgnLCcsICcnKTtcclxuICBsZXQgY3VycmVuY3k6IHN0cmluZyB8IG51bGwgPSBudWxsO1xyXG4gIGxldCBhbW91bnQ6IG51bWJlciB8IG51bGwgPSBudWxsO1xyXG4gIGlmIChhbW91bnRTdHJDbG4uaW5jbHVkZXMoU0hFS0VMX0NVUlJFTkNZX1NZTUJPTCkpIHtcclxuICAgIGFtb3VudCA9IHBhcnNlRmxvYXQoYW1vdW50U3RyQ2xuLnJlcGxhY2UoU0hFS0VMX0NVUlJFTkNZX1NZTUJPTCwgJycpKTtcclxuICAgIGN1cnJlbmN5ID0gU0hFS0VMX0NVUlJFTkNZO1xyXG4gIH0gZWxzZSBpZiAoYW1vdW50U3RyQ2xuLmluY2x1ZGVzKERPTExBUl9DVVJSRU5DWV9TWU1CT0wpKSB7XHJcbiAgICBhbW91bnQgPSBwYXJzZUZsb2F0KGFtb3VudFN0ckNsbi5yZXBsYWNlKERPTExBUl9DVVJSRU5DWV9TWU1CT0wsICcnKSk7XHJcbiAgICBjdXJyZW5jeSA9IERPTExBUl9DVVJSRU5DWTtcclxuICB9IGVsc2UgaWYgKGFtb3VudFN0ckNsbi5pbmNsdWRlcyhFVVJPX0NVUlJFTkNZX1NZTUJPTCkpIHtcclxuICAgIGFtb3VudCA9IHBhcnNlRmxvYXQoYW1vdW50U3RyQ2xuLnJlcGxhY2UoRVVST19DVVJSRU5DWV9TWU1CT0wsICcnKSk7XHJcbiAgICBjdXJyZW5jeSA9IEVVUk9fQ1VSUkVOQ1k7XHJcbiAgfSBlbHNlIHtcclxuICAgIGNvbnN0IHBhcnRzID0gYW1vdW50U3RyQ2xuLnNwbGl0KCcgJyk7XHJcbiAgICBbY3VycmVuY3ldID0gcGFydHM7XHJcbiAgICBhbW91bnQgPSBwYXJzZUZsb2F0KHBhcnRzWzFdKTtcclxuICB9XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBhbW91bnQsXHJcbiAgICBjdXJyZW5jeSxcclxuICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb252ZXJ0VHJhbnNhY3Rpb25zKHR4bnM6IFNjcmFwZWRUcmFuc2FjdGlvbltdKTogVHJhbnNhY3Rpb25bXSB7XHJcbiAgZGVidWcoYGNvbnZlcnQgJHt0eG5zLmxlbmd0aH0gcmF3IHRyYW5zYWN0aW9ucyB0byBvZmZpY2lhbCBUcmFuc2FjdGlvbiBzdHJ1Y3R1cmVgKTtcclxuICByZXR1cm4gdHhucy5tYXAodHhuID0+IHtcclxuICAgIGNvbnN0IGNoYXJnZWRBbW91bnRUdXBsZSA9IGdldEFtb3VudERhdGEodHhuLmNoYXJnZWRBbW91bnQgfHwgJycpO1xyXG4gICAgY29uc3QgdHhuUHJvY2Vzc2VkRGF0ZSA9IG1vbWVudCh0eG4uZGF0ZSwgREFURV9GT1JNQVQpO1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdDogVHJhbnNhY3Rpb24gPSB7XHJcbiAgICAgIHR5cGU6IFRyYW5zYWN0aW9uVHlwZXMuTm9ybWFsLFxyXG4gICAgICBzdGF0dXM6IFRyYW5zYWN0aW9uU3RhdHVzZXMuQ29tcGxldGVkLFxyXG4gICAgICBkYXRlOiB0eG5Qcm9jZXNzZWREYXRlLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgIHByb2Nlc3NlZERhdGU6IHR4blByb2Nlc3NlZERhdGUudG9JU09TdHJpbmcoKSxcclxuICAgICAgb3JpZ2luYWxBbW91bnQ6IGNoYXJnZWRBbW91bnRUdXBsZS5hbW91bnQsXHJcbiAgICAgIG9yaWdpbmFsQ3VycmVuY3k6IGNoYXJnZWRBbW91bnRUdXBsZS5jdXJyZW5jeSxcclxuICAgICAgY2hhcmdlZEFtb3VudDogY2hhcmdlZEFtb3VudFR1cGxlLmFtb3VudCxcclxuICAgICAgY2hhcmdlZEN1cnJlbmN5OiBjaGFyZ2VkQW1vdW50VHVwbGUuY3VycmVuY3ksXHJcbiAgICAgIGRlc2NyaXB0aW9uOiB0eG4uZGVzY3JpcHRpb24gfHwgJycsXHJcbiAgICAgIG1lbW86ICcnLFxyXG4gICAgICBpZGVudGlmaWVyOiB0eG4uaWRlbnRpZmllcixcclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9KTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hUcmFuc2FjdGlvbnMocGFnZTogUGFnZSwgb3B0aW9uczogU2NyYXBlck9wdGlvbnMpIHtcclxuICBhd2FpdCBwYWdlLmdvdG8oQ0FSRF9VUkwpO1xyXG4gIGF3YWl0IHdhaXRVbnRpbEVsZW1lbnRGb3VuZChwYWdlLCAnLnJlYWN0LWxvYWRpbmcuaGlkZScsIGZhbHNlKTtcclxuICBjb25zdCBkZWZhdWx0U3RhcnRNb21lbnQgPSBtb21lbnQoKS5zdWJ0cmFjdCgxLCAneWVhcnMnKTtcclxuICBjb25zdCBzdGFydERhdGUgPSBvcHRpb25zLnN0YXJ0RGF0ZSB8fCBkZWZhdWx0U3RhcnRNb21lbnQudG9EYXRlKCk7XHJcbiAgY29uc3Qgc3RhcnRNb21lbnQgPSBtb21lbnQubWF4KGRlZmF1bHRTdGFydE1vbWVudCwgbW9tZW50KHN0YXJ0RGF0ZSkpO1xyXG5cclxuICBjb25zdCBhY2NvdW50TnVtYmVyID0gYXdhaXQgcGFnZUV2YWwocGFnZSwgJy53YWxsZXQtZGV0YWlscyBkaXY6bnRoLW9mLXR5cGUoMiknLCBudWxsLCBlbGVtZW50ID0+IHtcclxuICAgIHJldHVybiAoZWxlbWVudCBhcyBhbnkpLmlubmVyVGV4dC5yZXBsYWNlKCfXnteh16TXqCDXm9eo15jXmdehICcsICcnKTtcclxuICB9KTtcclxuXHJcbiAgY29uc3QgYmFsYW5jZSA9IGF3YWl0IHBhZ2VFdmFsKHBhZ2UsICcud2FsbGV0LWRldGFpbHMgZGl2Om50aC1vZi10eXBlKDQpID4gc3BhbjpudGgtb2YtdHlwZSgyKScsIG51bGwsIGVsZW1lbnQgPT4ge1xyXG4gICAgcmV0dXJuIChlbGVtZW50IGFzIGFueSkuaW5uZXJUZXh0O1xyXG4gIH0pO1xyXG5cclxuICBkZWJ1ZygnZmV0Y2ggcmF3IHRyYW5zYWN0aW9ucyBmcm9tIHBhZ2UnKTtcclxuXHJcbiAgY29uc3QgcmF3VHJhbnNhY3Rpb25zOiAoU2NyYXBlZFRyYW5zYWN0aW9uIHwgbnVsbClbXSA9IGF3YWl0IHBhZ2VFdmFsQWxsPChTY3JhcGVkVHJhbnNhY3Rpb24gfCBudWxsKVtdPihcclxuICAgIHBhZ2UsXHJcbiAgICAnLnRyYW5zYWN0aW9uLWNvbnRhaW5lciwgLnRyYW5zYWN0aW9uLWNvbXBvbmVudC1jb250YWluZXInLFxyXG4gICAgW10sXHJcbiAgICBpdGVtcyA9PiB7XHJcbiAgICAgIHJldHVybiBpdGVtcy5tYXAoZWwgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNvbHVtbnM6IE5vZGVMaXN0T2Y8SFRNTFNwYW5FbGVtZW50PiA9IGVsLnF1ZXJ5U2VsZWN0b3JBbGwoJy50cmFuc2FjdGlvbi1pdGVtID4gc3BhbicpO1xyXG4gICAgICAgIGlmIChjb2x1bW5zLmxlbmd0aCA9PT0gNykge1xyXG4gICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgZGF0ZTogY29sdW1uc1swXS5pbm5lclRleHQsXHJcbiAgICAgICAgICAgIGlkZW50aWZpZXI6IGNvbHVtbnNbMV0uaW5uZXJUZXh0LFxyXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogY29sdW1uc1szXS5pbm5lclRleHQsXHJcbiAgICAgICAgICAgIHR5cGU6IGNvbHVtbnNbNV0uaW5uZXJUZXh0LFxyXG4gICAgICAgICAgICBjaGFyZ2VkQW1vdW50OiBjb2x1bW5zWzZdLmlubmVyVGV4dCxcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9KTtcclxuICAgIH0sXHJcbiAgKTtcclxuICBkZWJ1ZyhgZmV0Y2hlZCAke3Jhd1RyYW5zYWN0aW9ucy5sZW5ndGh9IHJhdyB0cmFuc2FjdGlvbnMgZnJvbSBwYWdlYCk7XHJcblxyXG4gIGNvbnN0IGFjY291bnRUcmFuc2FjdGlvbnMgPSBjb252ZXJ0VHJhbnNhY3Rpb25zKHJhd1RyYW5zYWN0aW9ucy5maWx0ZXIoaXRlbSA9PiAhIWl0ZW0pIGFzIFNjcmFwZWRUcmFuc2FjdGlvbltdKTtcclxuXHJcbiAgZGVidWcoJ2ZpbGVyIG91dCBvbGQgdHJhbnNhY3Rpb25zJyk7XHJcbiAgY29uc3QgdHhucyA9XHJcbiAgICAob3B0aW9ucy5vdXRwdXREYXRhPy5lbmFibGVUcmFuc2FjdGlvbnNGaWx0ZXJCeURhdGUgPz8gdHJ1ZSlcclxuICAgICAgPyBmaWx0ZXJPbGRUcmFuc2FjdGlvbnMoYWNjb3VudFRyYW5zYWN0aW9ucywgc3RhcnRNb21lbnQsIGZhbHNlKVxyXG4gICAgICA6IGFjY291bnRUcmFuc2FjdGlvbnM7XHJcbiAgZGVidWcoXHJcbiAgICBgZm91bmQgJHt0eG5zLmxlbmd0aH0gdmFsaWQgdHJhbnNhY3Rpb25zIG91dCBvZiAke2FjY291bnRUcmFuc2FjdGlvbnMubGVuZ3RofSB0cmFuc2FjdGlvbnMgZm9yIGFjY291bnQgZW5kaW5nIHdpdGggJHthY2NvdW50TnVtYmVyLnN1YnN0cmluZyhhY2NvdW50TnVtYmVyLmxlbmd0aCAtIDIpfWAsXHJcbiAgKTtcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGFjY291bnROdW1iZXIsXHJcbiAgICBiYWxhbmNlOiBnZXRBbW91bnREYXRhKGJhbGFuY2UpLmFtb3VudCxcclxuICAgIHR4bnMsXHJcbiAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0UG9zc2libGVMb2dpblJlc3VsdHMoKTogUG9zc2libGVMb2dpblJlc3VsdHMge1xyXG4gIGNvbnN0IHVybHM6IFBvc3NpYmxlTG9naW5SZXN1bHRzID0ge307XHJcbiAgdXJsc1tMb2dpblJlc3VsdHMuU3VjY2Vzc10gPSBbU1VDQ0VTU19VUkxdO1xyXG4gIHVybHNbTG9naW5SZXN1bHRzLkNoYW5nZVBhc3N3b3JkXSA9IFtdOyAvLyBUT0RPXHJcbiAgdXJsc1tMb2dpblJlc3VsdHMuSW52YWxpZFBhc3N3b3JkXSA9IFtdOyAvLyBUT0RPXHJcbiAgdXJsc1tMb2dpblJlc3VsdHMuVW5rbm93bkVycm9yXSA9IFtdOyAvLyBUT0RPXHJcbiAgcmV0dXJuIHVybHM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZUxvZ2luRmllbGRzKGNyZWRlbnRpYWxzOiBTY3JhcGVyU3BlY2lmaWNDcmVkZW50aWFscykge1xyXG4gIHJldHVybiBbXHJcbiAgICB7IHNlbGVjdG9yOiAnI2xvZ2luSWQnLCB2YWx1ZTogY3JlZGVudGlhbHMuaWQgfSxcclxuICAgIHsgc2VsZWN0b3I6ICcjbG9naW5QYXNzd29yZCcsIHZhbHVlOiBjcmVkZW50aWFscy5wYXNzd29yZCB9LFxyXG4gIF07XHJcbn1cclxuXHJcbnR5cGUgU2NyYXBlclNwZWNpZmljQ3JlZGVudGlhbHMgPSB7IGlkOiBzdHJpbmc7IHBhc3N3b3JkOiBzdHJpbmcgfTtcclxuXHJcbmNsYXNzIEJleWFoYWRCaXNodmlsaGFTY3JhcGVyIGV4dGVuZHMgQmFzZVNjcmFwZXJXaXRoQnJvd3NlcjxTY3JhcGVyU3BlY2lmaWNDcmVkZW50aWFscz4ge1xyXG4gIHByb3RlY3RlZCBnZXRWaWV3UG9ydCgpOiB7IHdpZHRoOiBudW1iZXI7IGhlaWdodDogbnVtYmVyIH0ge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgd2lkdGg6IDE1MDAsXHJcbiAgICAgIGhlaWdodDogODAwLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGdldExvZ2luT3B0aW9ucyhjcmVkZW50aWFsczogU2NyYXBlclNwZWNpZmljQ3JlZGVudGlhbHMpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGxvZ2luVXJsOiBMT0dJTl9VUkwsXHJcbiAgICAgIGZpZWxkczogY3JlYXRlTG9naW5GaWVsZHMoY3JlZGVudGlhbHMpLFxyXG4gICAgICBzdWJtaXRCdXR0b25TZWxlY3RvcjogYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGJ1dHRvbiA9IGF3YWl0IHRoaXMucGFnZS4kKCd4cGF0aC8vYnV0dG9uW2NvbnRhaW5zKC4sIFwi15TXqteX15HXqFwiKV0nKTtcclxuICAgICAgICBpZiAoYnV0dG9uKSB7XHJcbiAgICAgICAgICBhd2FpdCBidXR0b24uY2xpY2soKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICAgIHBvc3NpYmxlUmVzdWx0czogZ2V0UG9zc2libGVMb2dpblJlc3VsdHMoKSxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBhc3luYyBmZXRjaERhdGEoKSB7XHJcbiAgICBjb25zdCBhY2NvdW50ID0gYXdhaXQgZmV0Y2hUcmFuc2FjdGlvbnModGhpcy5wYWdlLCB0aGlzLm9wdGlvbnMpO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgYWNjb3VudHM6IFthY2NvdW50XSxcclxuICAgIH07XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBCZXlhaGFkQmlzaHZpbGhhU2NyYXBlcjtcclxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFBQSxPQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUE7QUFFQSxJQUFBQyxVQUFBLEdBQUFELE9BQUE7QUFRQSxJQUFBRSxNQUFBLEdBQUFGLE9BQUE7QUFDQSxJQUFBRyxxQkFBQSxHQUFBSCxPQUFBO0FBQ0EsSUFBQUksYUFBQSxHQUFBSixPQUFBO0FBQ0EsSUFBQUssY0FBQSxHQUFBTCxPQUFBO0FBQ0EsSUFBQU0sdUJBQUEsR0FBQU4sT0FBQTtBQUE4RyxTQUFBRCx1QkFBQVEsQ0FBQSxXQUFBQSxDQUFBLElBQUFBLENBQUEsQ0FBQUMsVUFBQSxHQUFBRCxDQUFBLEtBQUFFLE9BQUEsRUFBQUYsQ0FBQTtBQUc5RyxNQUFNRyxLQUFLLEdBQUcsSUFBQUMsZUFBUSxFQUFDLGtCQUFrQixDQUFDO0FBRTFDLE1BQU1DLFdBQVcsR0FBRyxVQUFVO0FB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QUMsQ0FBQztFQUNyQ0EsSUFBSSxDQUFDQyxvQ0FBWSxDQUFDQyxPQUFPLENBQUMsR0FBRyxDQUFDM0UsV0FBVyxDQUFDO0VBQzFDeUUsSUFBSSxDQUFDQyxvQ0FBWSxDQUFDRSxjQUFjLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztFQUN4Q0gsSUFBSSxDQUFDQyxvQ0FBWSxDQUFDRyxlQUFlLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztFQUN6Q0osSUFBSSxDQUFDQyxvQ0FBWSxDQUFDSSxZQUFZLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztFQUN0QyxPQUFPTCxJQUFJO0FBQ2I7QUFFQSxTQUFTTSxpQkFBaUJBLENBQUNDLFdBQXVDLEVBQUU7RUFDbEUsT0FBTyxDQUNMO0lBQUVDLFFBQVEsRUFBRSxVQUFVO0lBQUVDLEtBQUssRUFBRUYsV0FBVyxDQUFDRztFQUFHLENBQUMsRUFDL0M7SUFBRUYsUUFBUSxFQUFFLGdCQUFnQjtJQUFFQyxLQUFLLEVBQUVGLFdBQVcsQ0FBQ0k7RUFBUyxDQUFDLENBQzVEO0FBQ0g7QUFJQSxNQUFNQyx1QkFBdUIsU0FBU0MsOENBQXNCLENBQTZCO0VBQzdFQyxXQUFXQSxDQUFBLEVBQXNDO0lBQ3pELE9BQU87TUFDTEMsS0FBSyxFQUFFLElBQUk7TUFDWEMsTUFBTSxFQUFFO0lBQ1YsQ0FBQztFQUNIO0VBRUFDLGVBQWVBLENBQUNWLFdBQXVDLEVBQUU7SUFDdkQsT0FBTztNQUNMVyxRQUFRLEVBQUU1RixTQUFTO01BQ25CNkYsTUFBTSxFQUFFYixpQkFBaUIsQ0FBQ0MsV0FBVyxDQUFDO01BQ3RDYSxvQkFBb0IsRUFBRSxNQUFBQSxDQUFBLEtBQVk7UUFDaEMsTUFBTUMsTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDbEQsSUFBSSxDQUFDbUQsQ0FBQyxDQUFDLHFDQUFxQyxDQUFDO1FBQ3ZFLElBQUlELE1BQU0sRUFBRTtVQUNWLE1BQU1BLE1BQU0sQ0FBQ0UsS0FBSyxDQUFDLENBQUM7UUFDdEI7TUFDRixDQUFDO01BQ0RDLGVBQWUsRUFBRXpCLHVCQUF1QixDQUFDO0lBQzNDLENBQUM7RUFDSDtFQUVBLE1BQU0wQixTQUFTQSxDQUFBLEVBQUc7SUFDaEIsTUFBTUMsT0FBTyxHQUFHLE1BQU14RCxpQkFBaUIsQ0FBQyxJQUFJLENBQUNDLElBQUksRUFBRSxJQUFJLENBQUNDLE9BQU8sQ0FBQztJQUNoRSxPQUFPO01BQ0x1RCxPQUFPLEVBQUUsSUFBSTtNQUNiQyxRQUFRLEVBQUUsQ0FBQ0YsT0FBTztJQUNwQixDQUFDO0VBQ0g7QUFDRjtBQUFDLElBQUFHLFFBQUEsR0FBQUMsT0FBQSxDQUFBNUcsT0FBQSxHQUVjMEYsdUJBQXVCIiwiaWdub3JlTGlzdCI6W119
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _moment = _interopRequireDefault(require("moment/moment"));
var _debug = require("../helpers/debug");
var _fetch = require("../helpers/fetch");
var _transactions = require("../transactions");
var _baseScraper = require("./base-scraper");
var _errors = require("./errors");
var _oneZeroQueries = require("./one-zero-queries");
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const HEBREW_WORDS_REGEX = /[\u0590-\u05FF][\u0590-\u05FF"'\-_ /\\]*[\u0590-\u05FF]/g;
const debug = (0, _debug.getDebug)('one-zero');
const IDENTITY_SERVER_URL = 'https://identity.tfd-bank.com/v1/';
const GRAPHQL_API_URL = 'https://mobile.tfd-bank.com/mobile-graph/graphql';
class OneZeroScraper extends _baseScraper.BaseScraper {
  async triggerTwoFactorAuth(phoneNumber) {
    if (!phoneNumber.startsWith('+')) {
      return (0, _errors.createGenericError)('A full international phone number starting with + and a three digit country code is required');
    }
    debug('Fetching device token');
    const deviceTokenResponse = await (0, _fetch.fetchPost)(`${IDENTITY_SERVER_URL}/devices/token`, {
      extClientId: 'mobile',
      os: 'Android'
    });
    const {
      resultData: {
        deviceToken
      }
    } = deviceTokenResponse;
    debug(`Sending OTP to phone number ${phoneNumber}`);
    const otpPrepareResponse = await (0, _fetch.fetchPost)(`${IDENTITY_SERVER_URL}/otp/prepare`, {
      factorValue: phoneNumber,
      deviceToken,
      otpChannel: 'SMS_OTP'
    });
    const {
      resultData: {
        otpContext
      }
    } = otpPrepareResponse;
    this.otpContext = otpContext;
    return {
      success: true
    };
  }
  async getLongTermTwoFactorToken(otpCode) {
    if (!this.otpContext) {
      return (0, _errors.createGenericError)('triggerOtp was not called before calling getPermenantOtpToken()');
    }
    debug('Requesting OTP token');
    const otpVerifyResponse = await (0, _fetch.fetchPost)(`${IDENTITY_SERVER_URL}/otp/verify`, {
      otpContext: this.otpContext,
      otpCode
    });
    const {
      resultData: {
        otpToken
      }
    } = otpVerifyResponse;
    return {
      success: true,
      longTermTwoFactorAuthToken: otpToken
    };
  }
  async resolveOtpToken(credentials) {
    if ('otpLongTermToken' in credentials) {
      if (!credentials.otpLongTermToken) {
        return (0, _errors.createGenericError)('Invalid otpLongTermToken');
      }
      return {
        success: true,
        longTermTwoFactorAuthToken: credentials.otpLongTermToken
      };
    }
    if (!credentials.otpCodeRetriever) {
      return {
        success: false,
        errorType: _errors.ScraperErrorTypes.TwoFactorRetrieverMissing,
        errorMessage: 'otpCodeRetriever is required when otpPermanentToken is not provided'
      };
    }
    if (!credentials.phoneNumber) {
      return (0, _errors.createGenericError)('phoneNumber is required when providing a otpCodeRetriever callback');
    }
    debug('Triggering user supplied otpCodeRetriever callback');
    const triggerResult = await this.triggerTwoFactorAuth(credentials.phoneNumber);
    if (!triggerResult.success) {
      return triggerResult;
    }
    const otpCode = await credentials.otpCodeRetriever();
    const otpTokenResult = await this.getLongTermTwoFactorToken(otpCode);
    if (!otpTokenResult.success) {
      return otpTokenResult;
    }
    return {
      success: true,
      longTermTwoFactorAuthToken: otpTokenResult.longTermTwoFactorAuthToken
    };
  }
  async login(credentials) {
    const otpTokenResult = await this.resolveOtpToken(credentials);
    if (!otpTokenResult.success) {
      return otpTokenResult;
    }
    debug('Requesting id token');
    const getIdTokenResponse = await (0, _fetch.fetchPost)(`${IDENTITY_SERVER_URL}/getIdToken`, {
      otpSmsToken: otpTokenResult.longTermTwoFactorAuthToken,
      email: credentials.email,
      pass: credentials.password,
      pinCode: ''
    });
    const {
      resultData: {
        idToken
      }
    } = getIdTokenResponse;
    debug('Requesting session token');
    const getSessionTokenResponse = await (0, _fetch.fetchPost)(`${IDENTITY_SERVER_URL}/sessions/token`, {
      idToken,
      pass: credentials.password
    });
    const {
      resultData: {
        accessToken
      }
    } = getSessionTokenResponse;
    this.accessToken = accessToken;
    return {
      success: true,
      persistentOtpToken: otpTokenResult.longTermTwoFactorAuthToken
    };
  }
  async fetchPortfolioMovements(portfolio, startDate) {
    // TODO: Find out if we need the other accounts, there seems to always be one
    const account = portfolio.accounts[0];
    let cursor = null;
    const movements = [];
    while (!movements.length || new Date(movements[0].movementTimestamp) >= startDate) {
      debug(`Fetching transactions for account ${portfolio.portfolioNum}...`);
      const {
        movements: {
          movements: newMovements,
          pagination
        }
      } = await (0, _fetch.fetchGraphql)(GRAPHQL_API_URL, _oneZeroQueries.GET_MOVEMENTS, {
        portfolioId: portfolio.portfolioId,
        accountId: account.accountId,
        language: 'HEBREW',
        pagination: {
          cursor,
          limit: 50
        }
      }, {
        authorization: `Bearer ${this.accessToken}`
      });
      movements.unshift(...newMovements);
      cursor = pagination.cursor;
      if (!pagination.hasMore) {
        break;
      }
    }
    movements.sort((x, y) => new Date(x.movementTimestamp).valueOf() - new Date(y.movementTimestamp).valueOf());
    const matchingMovements = movements.filter(movement => new Date(movement.movementTimestamp) >= startDate);
    return {
      accountNumber: portfolio.portfolioNum,
      balance: !movements.length ? 0 : parseFloat(movements[movements.length - 1].runningBalance),
      txns: matchingMovements.map(movement => {
        const hasInstallments = movement.transaction?.enrichment?.recurrences?.some(x => x.isRecurrent);
        const modifier = movement.creditDebit === 'DEBIT' ? -1 : 1;
        return {
          identifier: movement.movementId,
          date: movement.valueDate,
          chargedAmount: +movement.movementAmount * modifier,
          chargedCurrency: movement.movementCurrency,
          originalAmount: +movement.movementAmount * modifier,
          originalCurrency: movement.movementCurrency,
          description: this.sanitizeHebrew(movement.description),
          processedDate: movement.movementTimestamp,
          status: _transactions.TransactionStatuses.Completed,
          type: hasInstallments ? _transactions.TransactionTypes.Installments : _transactions.TransactionTypes.Normal
        };
      })
    };
  }

  /**
   * one zero hebrew strings are reversed with a unicode control character that forces display in LTR order
   * We need to remove the unicode control character, and then reverse hebrew substrings inside the string
   */
  sanitizeHebrew(text) {
    if (!text.includes('\u202d')) {
      return text.trim();
    }
    const plainString = text.replace(/\u202d/gi, '').trim();
    const hebrewSubStringsRanges = [...plainString.matchAll(HEBREW_WORDS_REGEX)];
    const rangesToReverse = hebrewSubStringsRanges.map(str => ({
      start: str.index,
      end: str.index + str[0].length
    }));
    const out = [];
    let index = 0;
    for (const {
      start,
      end
    } of rangesToReverse) {
      out.push(...plainString.substring(index, start));
      index += start - index;
      const reversed = [...plainString.substring(start, end)].reverse();
      out.push(...reversed);
      index += end - start;
    }
    out.push(...plainString.substring(index, plainString.length));
    return out.join('');
  }
  async fetchData() {
    if (!this.accessToken) {
      return (0, _errors.createGenericError)('login() was not called');
    }
    const defaultStartMoment = (0, _moment.default)().subtract(1, 'years').add(1, 'day');
    const startDate = this.options.startDate || defaultStartMoment.toDate();
    const startMoment = _moment.default.max(defaultStartMoment, (0, _moment.default)(startDate));
    debug('Fetching account list');
    const result = await (0, _fetch.fetchGraphql)(GRAPHQL_API_URL, _oneZeroQueries.GET_CUSTOMER, {}, {
      authorization: `Bearer ${this.accessToken}`
    });
    const portfolios = result.customer.flatMap(customer => customer.portfolios || []);
    return {
      success: true,
      accounts: await Promise.all(portfolios.map(portfolio => this.fetchPortfolioMovements(portfolio, startMoment.toDate())))
    };
  }
}
exports.default = OneZeroScraper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbW9tZW50IiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfZGVidWciLCJfZmV0Y2giLCJfdHJhbnNhY3Rpb25zIiwiX2Jhc2VTY3JhcGVyIiwiX2Vycm9ycyIsIl9vbmVaZXJvUXVlcmllcyIsImUiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsIkhFQlJFV19XT1JEU19SRUdFWCIsImRlYnVnIiwiZ2V0RGVidWciLCJJREVOVElUWV9TRVJWRVJfVVJMIiwiR1JBUEhRTF9BUElfVVJMIiwiT25lWmVyb1NjcmFwZXIiLCJCYXNlU2NyYXBlciIsInRyaWdnZXJUd29GYWN0b3JBdXRoIiwicGhvbmVOdW1iZXIiLCJzdGFydHNXaXRoIiwiY3JlYXRlR2VuZXJpY0Vycm9yIiwiZGV2aWNlVG9rZW5SZXNwb25zZSIsImZldGNoUG9zdCIsImV4dENsaWVudElkIiwib3MiLCJyZXN1bHREYXRhIiwiZGV2aWNlVG9rZW4iLCJvdHBQcmVwYXJlUmVzcG9uc2UiLCJmYWN0b3JWYWx1ZSIsIm90cENoYW5uZWwiLCJvdHBDb250ZXh0Iiwic3VjY2VzcyIsImdldExvbmdUZXJtVHdvRmFjdG9yVG9rZW4iLCJvdHBDb2RlIiwib3RwVmVyaWZ5UmVzcG9uc2UiLCJvdHBUb2tlbiIsImxvbmdUZXJtVHdvRmFjdG9yQXV0aFRva2VuIiwicmVzb2x2ZU90cFRva2VuIiwiY3JlZGVudGlhbHMiLCJvdHBMb25nVGVybVRva2VuIiwib3RwQ29kZVJldHJpZXZlciIsImVycm9yVHlwZSIsIlNjcmFwZXJFcnJvclR5cGVzIiwiVHdvRmFjdG9yUmV0cmlldmVyTWlzc2luZyIsImVycm9yTWVzc2FnZSIsInRyaWdnZXJSZXN1bHQiLCJvdHBUb2tlblJlc3VsdCIsImxvZ2luIiwiZ2V0SWRUb2tlblJlc3BvbnNlIiwib3RwU21zVG9rZW4iLCJlbWFpbCIsInBhc3MiLCJwYXNzd29yZCIsInBpbkNvZGUiLCJpZFRva2VuIiwiZ2V0U2Vzc2lvblRva2VuUmVzcG9uc2UiLCJhY2Nlc3NUb2tlbiIsInBlcnNpc3RlbnRPdHBUb2tlbiIsImZldGNoUG9ydGZvbGlvTW92ZW1lbnRzIiwicG9ydGZvbGlvIiwic3RhcnREYXRlIiwiYWNjb3VudCIsImFjY291bnRzIiwiY3Vyc29yIiwibW92ZW1lbnRzIiwibGVuZ3RoIiwiRGF0ZSIsIm1vdmVtZW50VGltZXN0YW1wIiwicG9ydGZvbGlvTnVtIiwibmV3TW92ZW1lbnRzIiwicGFnaW5hdGlvbiIsImZldGNoR3JhcGhxbCIsIkdFVF9NT1ZFTUVOVFMiLCJwb3J0Zm9saW9JZCIsImFjY291bnRJZCIsImxhbmd1YWdlIiwibGltaXQiLCJhdXRob3JpemF0aW9uIiwidW5zaGlmdCIsImhhc01vcmUiLCJzb3J0IiwieCIsInkiLCJ2YWx1ZU9mIiwibWF0Y2hpbmdNb3ZlbWVudHMiLCJmaWx0ZXIiLCJtb3ZlbWVudCIsImFjY291bnROdW1iZXIiLCJiYWxhbmNlIiwicGFyc2VGbG9hdCIsInJ1bm5pbmdCYWxhbmNlIiwidHhucyIsIm1hcCIsImhhc0luc3RhbGxtZW50cyIsInRyYW5zYWN0aW9uIiwiZW5yaWNobWVudCIsInJlY3VycmVuY2VzIiwic29tZSIsImlzUmVjdXJyZW50IiwibW9kaWZpZXIiLCJjcmVkaXREZWJpdCIsImlkZW50aWZpZXIiLCJtb3ZlbWVudElkIiwiZGF0ZSIsInZhbHVlRGF0ZSIsImNoYXJnZWRBbW91bnQiLCJtb3ZlbWVudEFtb3VudCIsImNoYXJnZWRDdXJyZW5jeSIsIm1vdmVtZW50Q3VycmVuY3kiLCJvcmlnaW5hbEFtb3VudCIsIm9yaWdpbmFsQ3VycmVuY3kiLCJkZXNjcmlwdGlvbiIsInNhbml0aXplSGVicmV3IiwicHJvY2Vzc2VkRGF0ZSIsInN0YXR1cyIsIlRyYW5zYWN0aW9uU3RhdHVzZXMiLCJDb21wbGV0ZWQiLCJ0eXBlIiwiVHJhbnNhY3Rpb25UeXBlcyIsIkluc3RhbGxtZW50cyIsIk5vcm1hbCIsInRleHQiLCJpbmNsdWRlcyIsInRyaW0iLCJwbGFpblN0cmluZyIsInJlcGxhY2UiLCJoZWJyZXdTdWJTdHJpbmdzUmFuZ2VzIiwibWF0Y2hBbGwiLCJyYW5nZXNUb1JldmVyc2UiLCJzdHIiLCJzdGFydCIsImluZGV4IiwiZW5kIiwib3V0IiwicHVzaCIsInN1YnN0cmluZyIsInJldmVyc2VkIiwicmV2ZXJzZSIsImpvaW4iLCJmZXRjaERhdGEiLCJkZWZhdWx0U3RhcnRNb21lbnQiLCJtb21lbnQiLCJzdWJ0cmFjdCIsImFkZCIsIm9wdGlvbnMiLCJ0b0RhdGUiLCJzdGFydE1vbWVudCIsIm1heCIsInJlc3VsdCIsIkdFVF9DVVNUT01FUiIsInBvcnRmb2xpb3MiLCJjdXN0b21lciIsImZsYXRNYXAiLCJQcm9taXNlIiwiYWxsIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JhcGVycy9vbmUtemVyby50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudC9tb21lbnQnO1xyXG5pbXBvcnQgeyBnZXREZWJ1ZyB9IGZyb20gJy4uL2hlbHBlcnMvZGVidWcnO1xyXG5pbXBvcnQgeyBmZXRjaEdyYXBocWwsIGZldGNoUG9zdCB9IGZyb20gJy4uL2hlbHBlcnMvZmV0Y2gnO1xyXG5pbXBvcnQge1xyXG4gIHR5cGUgVHJhbnNhY3Rpb24gYXMgU2NyYXBpbmdUcmFuc2FjdGlvbixcclxuICBUcmFuc2FjdGlvblN0YXR1c2VzLFxyXG4gIFRyYW5zYWN0aW9uVHlwZXMsXHJcbiAgdHlwZSBUcmFuc2FjdGlvbnNBY2NvdW50LFxyXG59IGZyb20gJy4uL3RyYW5zYWN0aW9ucyc7XHJcbmltcG9ydCB7IEJhc2VTY3JhcGVyIH0gZnJvbSAnLi9iYXNlLXNjcmFwZXInO1xyXG5pbXBvcnQgeyBTY3JhcGVyRXJyb3JUeXBlcywgY3JlYXRlR2VuZXJpY0Vycm9yIH0gZnJvbSAnLi9lcnJvcnMnO1xyXG5pbXBvcnQge1xyXG4gIHR5cGUgU2NyYXBlckdldExvbmdUZXJtVHdvRmFjdG9yVG9rZW5SZXN1bHQsXHJcbiAgdHlwZSBTY3JhcGVyTG9naW5SZXN1bHQsXHJcbiAgdHlwZSBTY3JhcGVyU2NyYXBpbmdSZXN1bHQsXHJcbiAgdHlwZSBTY3JhcGVyVHdvRmFjdG9yQXV0aFRyaWdnZXJSZXN1bHQsXHJcbn0gZnJvbSAnLi9pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBHRVRfQ1VTVE9NRVIsIEdFVF9NT1ZFTUVOVFMgfSBmcm9tICcuL29uZS16ZXJvLXF1ZXJpZXMnO1xyXG5cclxuY29uc3QgSEVCUkVXX1dPUkRTX1JFR0VYID0gL1tcXHUwNTkwLVxcdTA1RkZdW1xcdTA1OTAtXFx1MDVGRlwiJ1xcLV8gL1xcXFxdKltcXHUwNTkwLVxcdTA1RkZdL2c7XHJcblxyXG5jb25zdCBkZWJ1ZyA9IGdldERlYnVnKCdvbmUtemVybycpO1xyXG5cclxudHlwZSBBY2NvdW50ID0ge1xyXG4gIGFjY291bnRJZDogc3RyaW5nO1xyXG59O1xyXG5cclxudHlwZSBQb3J0Zm9saW8gPSB7XHJcbiAgYWNjb3VudHM6IEFycmF5PEFjY291bnQ+O1xyXG4gIHBvcnRmb2xpb0lkOiBzdHJpbmc7XHJcbiAgcG9ydGZvbGlvTnVtOiBzdHJpbmc7XHJcbn07XHJcblxyXG50eXBlIEN1c3RvbWVyID0ge1xyXG4gIGN1c3RvbWVySWQ6IHN0cmluZztcclxuICBwb3J0Zm9saW9zPzogQXJyYXk8UG9ydGZvbGlvPiB8IG51bGw7XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBDYXRlZ29yeSA9IHtcclxuICBjYXRlZ29yeUlkOiBudW1iZXI7XHJcbiAgZGF0YVNvdXJjZTogc3RyaW5nO1xyXG4gIHN1YkNhdGVnb3J5SWQ/OiBudW1iZXIgfCBudWxsO1xyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgUmVjdXJyZW5jZSA9IHtcclxuICBkYXRhU291cmNlOiBzdHJpbmc7XHJcbiAgaXNSZWN1cnJlbnQ6IGJvb2xlYW47XHJcbn07XHJcblxyXG50eXBlIFRyYW5zYWN0aW9uRW5yaWNobWVudCA9IHtcclxuICBjYXRlZ29yaWVzPzogQ2F0ZWdvcnlbXSB8IG51bGw7XHJcbiAgcmVjdXJyZW5jZXM/OiBSZWN1cnJlbmNlW10gfCBudWxsO1xyXG59O1xyXG5cclxudHlwZSBUcmFuc2FjdGlvbiA9IHtcclxuICBlbnJpY2htZW50PzogVHJhbnNhY3Rpb25FbnJpY2htZW50IHwgbnVsbDtcclxuICAvLyBUT0RPOiBHZXQgaW5zdGFsbG1lbnRzIGluZm9ybWF0aW9uIGhlcmVcclxuICAvLyB0cmFuc2FjdGlvbkRldGFpbHM6IFRyYW5zYWN0aW9uRGV0YWlscztcclxufTtcclxuXHJcbnR5cGUgTW92ZW1lbnQgPSB7XHJcbiAgYWNjb3VudElkOiBzdHJpbmc7XHJcbiAgYmFua0N1cnJlbmN5QW1vdW50OiBzdHJpbmc7XHJcbiAgYm9va2luZ0RhdGU6IHN0cmluZztcclxuICBjb252ZXJzaW9uUmF0ZTogc3RyaW5nO1xyXG4gIGNyZWRpdERlYml0OiBzdHJpbmc7XHJcbiAgZGVzY3JpcHRpb246IHN0cmluZztcclxuICBpc1JldmVyc2VkOiBib29sZWFuO1xyXG4gIG1vdmVtZW50QW1vdW50OiBzdHJpbmc7XHJcbiAgbW92ZW1lbnRDdXJyZW5jeTogc3RyaW5nO1xyXG4gIG1vdmVtZW50SWQ6IHN0cmluZztcclxuICBtb3ZlbWVudFJldmVyc2VkSWQ/OiBzdHJpbmcgfCBudWxsO1xyXG4gIG1vdmVtZW50VGltZXN0YW1wOiBzdHJpbmc7XHJcbiAgbW92ZW1lbnRUeXBlOiBzdHJpbmc7XHJcbiAgcG9ydGZvbGlvSWQ6IHN0cmluZztcclxuICBydW5uaW5nQmFsYW5jZTogc3RyaW5nO1xyXG4gIHRyYW5zYWN0aW9uPzogVHJhbnNhY3Rpb24gfCBudWxsO1xyXG4gIHZhbHVlRGF0ZTogc3RyaW5nO1xyXG59O1xyXG5cclxudHlwZSBRdWVyeVBhZ2luYXRpb24gPSB7IGhhc01vcmU6IGJvb2xlYW47IGN1cnNvcjogc3RyaW5nIH07XHJcblxyXG5jb25zdCBJREVOVElUWV9TRVJWRVJfVVJMID0gJ2h0dHBzOi8vaWRlbnRpdHkudGZkLWJhbmsuY29tL3YxLyc7XHJcblxyXG5jb25zdCBHUkFQSFFMX0FQSV9VUkwgPSAnaHR0cHM6Ly9tb2JpbGUudGZkLWJhbmsuY29tL21vYmlsZS1ncmFwaC9ncmFwaHFsJztcclxuXHJcbnR5cGUgU2NyYXBlclNwZWNpZmljQ3JlZGVudGlhbHMgPSB7IGVtYWlsOiBzdHJpbmc7IHBhc3N3b3JkOiBzdHJpbmcgfSAmIChcclxuICB8IHtcclxuICAgICAgb3RwQ29kZVJldHJpZXZlcjogKCkgPT4gUHJvbWlzZTxzdHJpbmc+O1xyXG4gICAgICBwaG9uZU51bWJlcjogc3RyaW5nO1xyXG4gICAgfVxyXG4gIHwge1xyXG4gICAgICBvdHBMb25nVGVybVRva2VuOiBzdHJpbmc7XHJcbiAgICB9XHJcbik7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPbmVaZXJvU2NyYXBlciBleHRlbmRzIEJhc2VTY3JhcGVyPFNjcmFwZXJTcGVjaWZpY0NyZWRlbnRpYWxzPiB7XHJcbiAgcHJpdmF0ZSBvdHBDb250ZXh0Pzogc3RyaW5nO1xyXG5cclxuICBwcml2YXRlIGFjY2Vzc1Rva2VuPzogc3RyaW5nO1xyXG5cclxuICBhc3luYyB0cmlnZ2VyVHdvRmFjdG9yQXV0aChwaG9uZU51bWJlcjogc3RyaW5nKTogUHJvbWlzZTxTY3JhcGVyVHdvRmFjdG9yQXV0aFRyaWdnZXJSZXN1bHQ+IHtcclxuICAgIGlmICghcGhvbmVOdW1iZXIuc3RhcnRzV2l0aCgnKycpKSB7XHJcbiAgICAgIHJldHVybiBjcmVhdGVHZW5lcmljRXJyb3IoXHJcbiAgICAgICAgJ0EgZnVsbCBpbnRlcm5hdGlvbmFsIHBob25lIG51bWJlciBzdGFydGluZyB3aXRoICsgYW5kIGEgdGhyZWUgZGlnaXQgY291bnRyeSBjb2RlIGlzIHJlcXVpcmVkJyxcclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBkZWJ1ZygnRmV0Y2hpbmcgZGV2aWNlIHRva2VuJyk7XHJcbiAgICBjb25zdCBkZXZpY2VUb2tlblJlc3BvbnNlID0gYXdhaXQgZmV0Y2hQb3N0KGAke0lERU5USVRZX1NFUlZFUl9VUkx9L2RldmljZXMvdG9rZW5gLCB7XHJcbiAgICAgIGV4dENsaWVudElkOiAnbW9iaWxlJyxcclxuICAgICAgb3M6ICdBbmRyb2lkJyxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IHtcclxuICAgICAgcmVzdWx0RGF0YTogeyBkZXZpY2VUb2tlbiB9LFxyXG4gICAgfSA9IGRldmljZVRva2VuUmVzcG9uc2U7XHJcblxyXG4gICAgZGVidWcoYFNlbmRpbmcgT1RQIHRvIHBob25lIG51bWJlciAke3Bob25lTnVtYmVyfWApO1xyXG5cclxuICAgIGNvbnN0IG90cFByZXBhcmVSZXNwb25zZSA9IGF3YWl0IGZldGNoUG9zdChgJHtJREVOVElUWV9TRVJWRVJfVVJMfS9vdHAvcHJlcGFyZWAsIHtcclxuICAgICAgZmFjdG9yVmFsdWU6IHBob25lTnVtYmVyLFxyXG4gICAgICBkZXZpY2VUb2tlbixcclxuICAgICAgb3RwQ2hhbm5lbDogJ1NNU19PVFAnLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3Qge1xyXG4gICAgICByZXN1bHREYXRhOiB7IG90cENvbnRleHQgfSxcclxuICAgIH0gPSBvdHBQcmVwYXJlUmVzcG9uc2U7XHJcblxyXG4gICAgdGhpcy5vdHBDb250ZXh0ID0gb3RwQ29udGV4dDtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBnZXRMb25nVGVybVR3b0ZhY3RvclRva2VuKG90cENvZGU6IHN0cmluZyk6IFByb21pc2U8U2NyYXBlckdldExvbmdUZXJtVHdvRmFjdG9yVG9rZW5SZXN1bHQ+IHtcclxuICAgIGlmICghdGhpcy5vdHBDb250ZXh0KSB7XHJcbiAgICAgIHJldHVybiBjcmVhdGVHZW5lcmljRXJyb3IoJ3RyaWdnZXJPdHAgd2FzIG5vdCBjYWxsZWQgYmVmb3JlIGNhbGxpbmcgZ2V0UGVybWVuYW50T3RwVG9rZW4oKScpO1xyXG4gICAgfVxyXG5cclxuICAgIGRlYnVnKCdSZXF1ZXN0aW5nIE9UUCB0b2tlbicpO1xyXG4gICAgY29uc3Qgb3RwVmVyaWZ5UmVzcG9uc2UgPSBhd2FpdCBmZXRjaFBvc3QoYCR7SURFTlRJVFlfU0VSVkVSX1VSTH0vb3RwL3ZlcmlmeWAsIHtcclxuICAgICAgb3RwQ29udGV4dDogdGhpcy5vdHBDb250ZXh0LFxyXG4gICAgICBvdHBDb2RlLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3Qge1xyXG4gICAgICByZXN1bHREYXRhOiB7IG90cFRva2VuIH0sXHJcbiAgICB9ID0gb3RwVmVyaWZ5UmVzcG9uc2U7XHJcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBsb25nVGVybVR3b0ZhY3RvckF1dGhUb2tlbjogb3RwVG9rZW4gfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgcmVzb2x2ZU90cFRva2VuKFxyXG4gICAgY3JlZGVudGlhbHM6IFNjcmFwZXJTcGVjaWZpY0NyZWRlbnRpYWxzLFxyXG4gICk6IFByb21pc2U8U2NyYXBlckdldExvbmdUZXJtVHdvRmFjdG9yVG9rZW5SZXN1bHQ+IHtcclxuICAgIGlmICgnb3RwTG9uZ1Rlcm1Ub2tlbicgaW4gY3JlZGVudGlhbHMpIHtcclxuICAgICAgaWYgKCFjcmVkZW50aWFscy5vdHBMb25nVGVybVRva2VuKSB7XHJcbiAgICAgICAgcmV0dXJuIGNyZWF0ZUdlbmVyaWNFcnJvcignSW52YWxpZCBvdHBMb25nVGVybVRva2VuJyk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgbG9uZ1Rlcm1Ud29GYWN0b3JBdXRoVG9rZW46IGNyZWRlbnRpYWxzLm90cExvbmdUZXJtVG9rZW4gfTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWNyZWRlbnRpYWxzLm90cENvZGVSZXRyaWV2ZXIpIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvclR5cGU6IFNjcmFwZXJFcnJvclR5cGVzLlR3b0ZhY3RvclJldHJpZXZlck1pc3NpbmcsXHJcbiAgICAgICAgZXJyb3JNZXNzYWdlOiAnb3RwQ29kZVJldHJpZXZlciBpcyByZXF1aXJlZCB3aGVuIG90cFBlcm1hbmVudFRva2VuIGlzIG5vdCBwcm92aWRlZCcsXHJcbiAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFjcmVkZW50aWFscy5waG9uZU51bWJlcikge1xyXG4gICAgICByZXR1cm4gY3JlYXRlR2VuZXJpY0Vycm9yKCdwaG9uZU51bWJlciBpcyByZXF1aXJlZCB3aGVuIHByb3ZpZGluZyBhIG90cENvZGVSZXRyaWV2ZXIgY2FsbGJhY2snKTtcclxuICAgIH1cclxuXHJcbiAgICBkZWJ1ZygnVHJpZ2dlcmluZyB1c2VyIHN1cHBsaWVkIG90cENvZGVSZXRyaWV2ZXIgY2FsbGJhY2snKTtcclxuICAgIGNvbnN0IHRyaWdnZXJSZXN1bHQgPSBhd2FpdCB0aGlzLnRyaWdnZXJUd29GYWN0b3JBdXRoKGNyZWRlbnRpYWxzLnBob25lTnVtYmVyKTtcclxuXHJcbiAgICBpZiAoIXRyaWdnZXJSZXN1bHQuc3VjY2Vzcykge1xyXG4gICAgICByZXR1cm4gdHJpZ2dlclJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBvdHBDb2RlID0gYXdhaXQgY3JlZGVudGlhbHMub3RwQ29kZVJldHJpZXZlcigpO1xyXG5cclxuICAgIGNvbnN0IG90cFRva2VuUmVzdWx0ID0gYXdhaXQgdGhpcy5nZXRMb25nVGVybVR3b0ZhY3RvclRva2VuKG90cENvZGUpO1xyXG4gICAgaWYgKCFvdHBUb2tlblJlc3VsdC5zdWNjZXNzKSB7XHJcbiAgICAgIHJldHVybiBvdHBUb2tlblJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBsb25nVGVybVR3b0ZhY3RvckF1dGhUb2tlbjogb3RwVG9rZW5SZXN1bHQubG9uZ1Rlcm1Ud29GYWN0b3JBdXRoVG9rZW4gfTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGxvZ2luKGNyZWRlbnRpYWxzOiBTY3JhcGVyU3BlY2lmaWNDcmVkZW50aWFscyk6IFByb21pc2U8U2NyYXBlckxvZ2luUmVzdWx0PiB7XHJcbiAgICBjb25zdCBvdHBUb2tlblJlc3VsdCA9IGF3YWl0IHRoaXMucmVzb2x2ZU90cFRva2VuKGNyZWRlbnRpYWxzKTtcclxuICAgIGlmICghb3RwVG9rZW5SZXN1bHQuc3VjY2Vzcykge1xyXG4gICAgICByZXR1cm4gb3RwVG9rZW5SZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgZGVidWcoJ1JlcXVlc3RpbmcgaWQgdG9rZW4nKTtcclxuICAgIGNvbnN0IGdldElkVG9rZW5SZXNwb25zZSA9IGF3YWl0IGZldGNoUG9zdChgJHtJREVOVElUWV9TRVJWRVJfVVJMfS9nZXRJZFRva2VuYCwge1xyXG4gICAgICBvdHBTbXNUb2tlbjogb3RwVG9rZW5SZXN1bHQubG9uZ1Rlcm1Ud29GYWN0b3JBdXRoVG9rZW4sXHJcbiAgICAgIGVtYWlsOiBjcmVkZW50aWFscy5lbWFpbCxcclxuICAgICAgcGFzczogY3JlZGVudGlhbHMucGFzc3dvcmQsXHJcbiAgICAgIHBpbkNvZGU6ICcnLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3Qge1xyXG4gICAgICByZXN1bHREYXRhOiB7IGlkVG9rZW4gfSxcclxuICAgIH0gPSBnZXRJZFRva2VuUmVzcG9uc2U7XHJcblxyXG4gICAgZGVidWcoJ1JlcXVlc3Rpbmcgc2Vzc2lvbiB0b2tlbicpO1xyXG5cclxuICAgIGNvbnN0IGdldFNlc3Npb25Ub2tlblJlc3BvbnNlID0gYXdhaXQgZmV0Y2hQb3N0KGAke0lERU5USVRZX1NFUlZFUl9VUkx9L3Nlc3Npb25zL3Rva2VuYCwge1xyXG4gICAgICBpZFRva2VuLFxyXG4gICAgICBwYXNzOiBjcmVkZW50aWFscy5wYXNzd29yZCxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IHtcclxuICAgICAgcmVzdWx0RGF0YTogeyBhY2Nlc3NUb2tlbiB9LFxyXG4gICAgfSA9IGdldFNlc3Npb25Ub2tlblJlc3BvbnNlO1xyXG5cclxuICAgIHRoaXMuYWNjZXNzVG9rZW4gPSBhY2Nlc3NUb2tlbjtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICBwZXJzaXN0ZW50T3RwVG9rZW46IG90cFRva2VuUmVzdWx0LmxvbmdUZXJtVHdvRmFjdG9yQXV0aFRva2VuLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgZmV0Y2hQb3J0Zm9saW9Nb3ZlbWVudHMocG9ydGZvbGlvOiBQb3J0Zm9saW8sIHN0YXJ0RGF0ZTogRGF0ZSk6IFByb21pc2U8VHJhbnNhY3Rpb25zQWNjb3VudD4ge1xyXG4gICAgLy8gVE9ETzogRmluZCBvdXQgaWYgd2UgbmVlZCB0aGUgb3RoZXIgYWNjb3VudHMsIHRoZXJlIHNlZW1zIHRvIGFsd2F5cyBiZSBvbmVcclxuICAgIGNvbnN0IGFjY291bnQgPSBwb3J0Zm9saW8uYWNjb3VudHNbMF07XHJcbiAgICBsZXQgY3Vyc29yID0gbnVsbDtcclxuICAgIGNvbnN0IG1vdmVtZW50cyA9IFtdO1xyXG5cclxuICAgIHdoaWxlICghbW92ZW1lbnRzLmxlbmd0aCB8fCBuZXcgRGF0ZShtb3ZlbWVudHNbMF0ubW92ZW1lbnRUaW1lc3RhbXApID49IHN0YXJ0RGF0ZSkge1xyXG4gICAgICBkZWJ1ZyhgRmV0Y2hpbmcgdHJhbnNhY3Rpb25zIGZvciBhY2NvdW50ICR7cG9ydGZvbGlvLnBvcnRmb2xpb051bX0uLi5gKTtcclxuICAgICAgY29uc3Qge1xyXG4gICAgICAgIG1vdmVtZW50czogeyBtb3ZlbWVudHM6IG5ld01vdmVtZW50cywgcGFnaW5hdGlvbiB9LFxyXG4gICAgICB9OiB7IG1vdmVtZW50czogeyBtb3ZlbWVudHM6IE1vdmVtZW50W107IHBhZ2luYXRpb246IFF1ZXJ5UGFnaW5hdGlvbiB9IH0gPSBhd2FpdCBmZXRjaEdyYXBocWwoXHJcbiAgICAgICAgR1JBUEhRTF9BUElfVVJMLFxyXG4gICAgICAgIEdFVF9NT1ZFTUVOVFMsXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcG9ydGZvbGlvSWQ6IHBvcnRmb2xpby5wb3J0Zm9saW9JZCxcclxuICAgICAgICAgIGFjY291bnRJZDogYWNjb3VudC5hY2NvdW50SWQsXHJcbiAgICAgICAgICBsYW5ndWFnZTogJ0hFQlJFVycsXHJcbiAgICAgICAgICBwYWdpbmF0aW9uOiB7XHJcbiAgICAgICAgICAgIGN1cnNvcixcclxuICAgICAgICAgICAgbGltaXQ6IDUwLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHsgYXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuYWNjZXNzVG9rZW59YCB9LFxyXG4gICAgICApO1xyXG5cclxuICAgICAgbW92ZW1lbnRzLnVuc2hpZnQoLi4ubmV3TW92ZW1lbnRzKTtcclxuICAgICAgY3Vyc29yID0gcGFnaW5hdGlvbi5jdXJzb3I7XHJcbiAgICAgIGlmICghcGFnaW5hdGlvbi5oYXNNb3JlKSB7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBtb3ZlbWVudHMuc29ydCgoeCwgeSkgPT4gbmV3IERhdGUoeC5tb3ZlbWVudFRpbWVzdGFtcCkudmFsdWVPZigpIC0gbmV3IERhdGUoeS5tb3ZlbWVudFRpbWVzdGFtcCkudmFsdWVPZigpKTtcclxuXHJcbiAgICBjb25zdCBtYXRjaGluZ01vdmVtZW50cyA9IG1vdmVtZW50cy5maWx0ZXIobW92ZW1lbnQgPT4gbmV3IERhdGUobW92ZW1lbnQubW92ZW1lbnRUaW1lc3RhbXApID49IHN0YXJ0RGF0ZSk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBhY2NvdW50TnVtYmVyOiBwb3J0Zm9saW8ucG9ydGZvbGlvTnVtLFxyXG4gICAgICBiYWxhbmNlOiAhbW92ZW1lbnRzLmxlbmd0aCA/IDAgOiBwYXJzZUZsb2F0KG1vdmVtZW50c1ttb3ZlbWVudHMubGVuZ3RoIC0gMV0ucnVubmluZ0JhbGFuY2UpLFxyXG4gICAgICB0eG5zOiBtYXRjaGluZ01vdmVtZW50cy5tYXAoKG1vdmVtZW50KTogU2NyYXBpbmdUcmFuc2FjdGlvbiA9PiB7XHJcbiAgICAgICAgY29uc3QgaGFzSW5zdGFsbG1lbnRzID0gbW92ZW1lbnQudHJhbnNhY3Rpb24/LmVucmljaG1lbnQ/LnJlY3VycmVuY2VzPy5zb21lKHggPT4geC5pc1JlY3VycmVudCk7XHJcbiAgICAgICAgY29uc3QgbW9kaWZpZXIgPSBtb3ZlbWVudC5jcmVkaXREZWJpdCA9PT0gJ0RFQklUJyA/IC0xIDogMTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgaWRlbnRpZmllcjogbW92ZW1lbnQubW92ZW1lbnRJZCxcclxuICAgICAgICAgIGRhdGU6IG1vdmVtZW50LnZhbHVlRGF0ZSxcclxuICAgICAgICAgIGNoYXJnZWRBbW91bnQ6ICttb3ZlbWVudC5tb3ZlbWVudEFtb3VudCAqIG1vZGlmaWVyLFxyXG4gICAgICAgICAgY2hhcmdlZEN1cnJlbmN5OiBtb3ZlbWVudC5tb3ZlbWVudEN1cnJlbmN5LFxyXG4gICAgICAgICAgb3JpZ2luYWxBbW91bnQ6ICttb3ZlbWVudC5tb3ZlbWVudEFtb3VudCAqIG1vZGlmaWVyLFxyXG4gICAgICAgICAgb3JpZ2luYWxDdXJyZW5jeTogbW92ZW1lbnQubW92ZW1lbnRDdXJyZW5jeSxcclxuICAgICAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLnNhbml0aXplSGVicmV3KG1vdmVtZW50LmRlc2NyaXB0aW9uKSxcclxuICAgICAgICAgIHByb2Nlc3NlZERhdGU6IG1vdmVtZW50Lm1vdmVtZW50VGltZXN0YW1wLFxyXG4gICAgICAgICAgc3RhdHVzOiBUcmFuc2FjdGlvblN0YXR1c2VzLkNvbXBsZXRlZCxcclxuICAgICAgICAgIHR5cGU6IGhhc0luc3RhbGxtZW50cyA/IFRyYW5zYWN0aW9uVHlwZXMuSW5zdGFsbG1lbnRzIDogVHJhbnNhY3Rpb25UeXBlcy5Ob3JtYWwsXHJcbiAgICAgICAgfTtcclxuICAgICAgfSksXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogb25lIHplcm8gaGVicmV3IHN0cmluZ3MgYXJlIHJldmVyc2VkIHdpdGggYSB1bmljb2RlIGNvbnRyb2wgY2hhcmFjdGVyIHRoYXQgZm9yY2VzIGRpc3BsYXkgaW4gTFRSIG9yZGVyXHJcbiAgICogV2UgbmVlZCB0byByZW1vdmUgdGhlIHVuaWNvZGUgY29udHJvbCBjaGFyYWN0ZXIsIGFuZCB0aGVuIHJldmVyc2UgaGVicmV3IHN1YnN0cmluZ3MgaW5zaWRlIHRoZSBzdHJpbmdcclxuICAgKi9cclxuICBwcml2YXRlIHNhbml0aXplSGVicmV3KHRleHQ6IHN0cmluZykge1xyXG4gICAgaWYgKCF0ZXh0LmluY2x1ZGVzKCdcXHUyMDJkJykpIHtcclxuICAgICAgcmV0dXJuIHRleHQudHJpbSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHBsYWluU3RyaW5nID0gdGV4dC5yZXBsYWNlKC9cXHUyMDJkL2dpLCAnJykudHJpbSgpO1xyXG4gICAgY29uc3QgaGVicmV3U3ViU3RyaW5nc1JhbmdlcyA9IFsuLi5wbGFpblN0cmluZy5tYXRjaEFsbChIRUJSRVdfV09SRFNfUkVHRVgpXTtcclxuICAgIGNvbnN0IHJhbmdlc1RvUmV2ZXJzZSA9IGhlYnJld1N1YlN0cmluZ3NSYW5nZXMubWFwKHN0ciA9PiAoeyBzdGFydDogc3RyLmluZGV4ISwgZW5kOiBzdHIuaW5kZXghICsgc3RyWzBdLmxlbmd0aCB9KSk7XHJcbiAgICBjb25zdCBvdXQgPSBbXTtcclxuICAgIGxldCBpbmRleCA9IDA7XHJcblxyXG4gICAgZm9yIChjb25zdCB7IHN0YXJ0LCBlbmQgfSBvZiByYW5nZXNUb1JldmVyc2UpIHtcclxuICAgICAgb3V0LnB1c2goLi4ucGxhaW5TdHJpbmcuc3Vic3RyaW5nKGluZGV4LCBzdGFydCkpO1xyXG4gICAgICBpbmRleCArPSBzdGFydCAtIGluZGV4O1xyXG4gICAgICBjb25zdCByZXZlcnNlZCA9IFsuLi5wbGFpblN0cmluZy5zdWJzdHJpbmcoc3RhcnQsIGVuZCldLnJldmVyc2UoKTtcclxuICAgICAgb3V0LnB1c2goLi4ucmV2ZXJzZWQpO1xyXG4gICAgICBpbmRleCArPSBlbmQgLSBzdGFydDtcclxuICAgIH1cclxuXHJcbiAgICBvdXQucHVzaCguLi5wbGFpblN0cmluZy5zdWJzdHJpbmcoaW5kZXgsIHBsYWluU3RyaW5nLmxlbmd0aCkpO1xyXG5cclxuICAgIHJldHVybiBvdXQuam9pbignJyk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBmZXRjaERhdGEoKTogUHJvbWlzZTxTY3JhcGVyU2NyYXBpbmdSZXN1bHQ+IHtcclxuICAgIGlmICghdGhpcy5hY2Nlc3NUb2tlbikge1xyXG4gICAgICByZXR1cm4gY3JlYXRlR2VuZXJpY0Vycm9yKCdsb2dpbigpIHdhcyBub3QgY2FsbGVkJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZGVmYXVsdFN0YXJ0TW9tZW50ID0gbW9tZW50KCkuc3VidHJhY3QoMSwgJ3llYXJzJykuYWRkKDEsICdkYXknKTtcclxuICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IHRoaXMub3B0aW9ucy5zdGFydERhdGUgfHwgZGVmYXVsdFN0YXJ0TW9tZW50LnRvRGF0ZSgpO1xyXG4gICAgY29uc3Qgc3RhcnRNb21lbnQgPSBtb21lbnQubWF4KGRlZmF1bHRTdGFydE1vbWVudCwgbW9tZW50KHN0YXJ0RGF0ZSkpO1xyXG5cclxuICAgIGRlYnVnKCdGZXRjaGluZyBhY2NvdW50IGxpc3QnKTtcclxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZldGNoR3JhcGhxbDx7IGN1c3RvbWVyOiBDdXN0b21lcltdIH0+KFxyXG4gICAgICBHUkFQSFFMX0FQSV9VUkwsXHJcbiAgICAgIEdFVF9DVVNUT01FUixcclxuICAgICAge30sXHJcbiAgICAgIHsgYXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuYWNjZXNzVG9rZW59YCB9LFxyXG4gICAgKTtcclxuICAgIGNvbnN0IHBvcnRmb2xpb3MgPSByZXN1bHQuY3VzdG9tZXIuZmxhdE1hcChjdXN0b21lciA9PiBjdXN0b21lci5wb3J0Zm9saW9zIHx8IFtdKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICBhY2NvdW50czogYXdhaXQgUHJvbWlzZS5hbGwoXHJcbiAgICAgICAgcG9ydGZvbGlvcy5tYXAocG9ydGZvbGlvID0+IHRoaXMuZmV0Y2hQb3J0Zm9saW9Nb3ZlbWVudHMocG9ydGZvbGlvLCBzdGFydE1vbWVudC50b0RhdGUoKSkpLFxyXG4gICAgICApLFxyXG4gICAgfTtcclxuICB9XHJcbn1cclxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFBQSxPQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBQyxNQUFBLEdBQUFELE9BQUE7QUFDQSxJQUFBRSxNQUFBLEdBQUFGLE9BQUE7QUFDQSxJQUFBRyxhQUFBLEdBQUFILE9BQUE7QUFNQSxJQUFBSSxZQUFBLEdBQUFKLE9BQUE7QUFDQSxJQUFBSyxPQUFBLEdBQUFMLE9BQUE7QUFPQSxJQUFBTSxlQUFBLEdBQUFOLE9BQUE7QUFBaUUsU0FBQUQsdUJBQUFRLENBQUEsV0FBQUEsQ0FBQSxJQUFBQSxDQUFBLENBQUFDLFVBQUEsR0FBQUQsQ0FBQSxLQUFBRSxPQUFBLEVBQUFGLENBQUE7QUFFakUsTUFBTUcsa0JBQWtCLEdBQUcsMERBQTBEO0FBRXJGLE1BQU1DLEtBQUssR0FBRyxJQUFBQyxlQUFRLEVBQUMsVUFBVSxDQUFDO0FBNkRsQyxNQUFNQyxtQkFBbUIsR0FBRyxtQ0FBbUM7QUFFL0QsTUFBTUMsZUFBZSxHQUFHLGtEQUFrRDtBQVkzRCxNQUFNQyxjQUFjLFNBQVNDLHdCQUFXLENBQTZCO0VBS2xGLE1BQU1DLG9CQUFvQkEsQ0FBQ0MsV0FBbUIsRUFBOEM7SUFDMUYsSUFBSSxDQUFDQSxXQUFXLENBQUNDLFVBQVUsQ0FBQyxHQUFHLENBQUMsRUFBRTtNQUNoQyxPQUFPLElBQUFDLDBCQUFrQixFQUN2Qiw4RkFDRixDQUFDO0lBQ0g7SUFFQVQsS0FBSyxDQUFDLHVCQUF1QixDQUFDO0lBQzlCLE1B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